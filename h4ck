#!/usr/bin/env python3

from cmd import Cmd

from fire import Fire

from lib.colors import *

BANNER = r"""
 _     _  _        _
| |__ | || |   ___| | __
| '_ \| || |_ / __| |/ /
| | | |__   _| (__|   <
|_| |_|  |_|  \___|_|\_\ """

class CommandLine(Cmd):
    prompt = 'h4ck> '
    __slots__ = ('_modules', '_module')

    def __init__(self):
        super().__init__()
        import pkgutil
        self._modules = [name for _,name,_ in pkgutil.iter_modules(['modules'])]
        self._module = None
        info('Available modules:', ', '.join(self._modules))

    def do_quit(self, _):
        raise KeyboardInterrupt

    def do_q(self, _):
        self.do_quit(_)

    @staticmethod
    def methods(module):
        from inspect import getmembers, isfunction
        return getmembers(module, isfunction)

    def get_names(self):
        return dir(self)

    def do_unload(self):
        if self._module:
            for m_name, _ in self.methods(self._module):
                delattr(self, 'do_%s' % m_name)
                delattr(self, 'help_%s' % m_name)

    def do_use(self, module):
        from importlib import import_module
        self.do_unload()
        try:
            self._module = import_module('modules.%s' % module)
            methods = []
            for m_name, method in self.methods(self._module):
                methods.append(m_name)
                setattr(self, 'do_%s' % m_name, method)
                setattr(self, 'help_%s' % m_name, lambda: print(method.__doc__))
            info('Methods:', ', '.join(methods))
        except ModuleNotFoundError:
            err('Module', module, 'not found')
        except Exception as e:
            err(repr(e))
        else:
            self.prompt = 'h4ck.%s> ' % module

    def complete_use(self, text, line, si, ei):
        completions = self._modules
        return completions


def main():
    from random import sample

    GREETINGS = [
        'Wh0a!',
        'Pwn3d',
        '1337',
        'Psst, do u want some exploits?',
        'P0w3r!',
        'I\'m in.',
        'All your base are belong to us!',
    ]

    CommandLine().cmdloop(
        '%s\n%s\n' % (
            BANNER, sample(GREETINGS, 1)[0]
        )
    )

if __name__ == "__main__":
    try:
        Fire(main)
    except KeyboardInterrupt:
        print('Exit')
